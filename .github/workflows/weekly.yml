name: Weekly heavy tests

on:
  schedule:
    - cron: '30 2 * * 5'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  mutation_test:
    runs-on: [self-hosted, test]

    strategy:
      matrix:
        service:
          - sql-driver
          - customer-service
          - supplier-service

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Run mutation tests
        working-directory: services/${{ matrix.service }}
        run: mvn clean test -Pmutation-tests -Djacoco.skip=true pitest:mutationCoverage

      - name: Upload mutation test report
        uses: actions/upload-artifact@v4
        with:
          name: pitest-${{ matrix.service }}
          path: services/${{ matrix.service }}/target/pit-reports

      - name: Parse PIT mutation score
        id: pit
        working-directory: services/${{ matrix.service }}
        run: |
          xml=target/pit-reports/mutations.xml

          if [ ! -f "$xml" ]; then
            echo "mutation_score=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          killed=$(xmllint --xpath "count(//mutation[@status='KILLED'])" "$xml")
          total=$(xmllint --xpath "count(//mutation)" "$xml")

          if [ "$total" -eq 0 ]; then
            score=0
          else
            score=$(awk "BEGIN { printf \"%.0f\", ($killed/$total)*100 }")
          fi

          echo "mutation_score=$score" >> $GITHUB_OUTPUT

      - name: Create GitHub issue if mutation score too low
        if: steps.pit.outputs.mutation_score < 60
        uses: actions/github-script@v7
        with:
          script: |
            const service = '${{ matrix.service }}'
            const score = '${{ steps.pit.outputs.mutation_score }}'

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Mutation score below threshold for ${service}`,
              body: `Mutation testing detected insufficient test quality.\n\nService: ${service}\nMutation score: ${score}%\nExpected minimum: 60%\n\nArtifact: pitest-${service}\n\nPlease review surviving mutations and improve tests.`})
