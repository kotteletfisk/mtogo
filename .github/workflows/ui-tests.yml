name: UI Acceptance Tests

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to test against'
        required: true
        type: string
      base_url:
        description: 'Base URL for tests'
        required: true
        type: string
    secrets:
      DB_PASSWORD:
        required: true
    outputs:
      test_result:
        description: 'Test execution result'
        value: ${{ jobs.run-ui-tests.outputs.result }}

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - test
          - prod
        default: test
      base_url:
        description: 'Base URL (optional, uses default for environment)'
        required: false
        type: string

jobs:
  run-ui-tests:
    runs-on: [self-hosted, ${{ inputs.environment }}]
    name: Run UI Tests on ${{ inputs.environment }}
    outputs:
      result: ${{ steps.test-execution.outcome }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Install Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Verify Chrome Installation
        run: google-chrome --version

      - name: Determine Base URL
        id: url
        run: |
          if [ -n "${{ inputs.base_url }}" ]; then
            BASE_URL="${{ inputs.base_url }}"
          elif [ "${{ inputs.environment }}" == "prod" ]; then
            BASE_URL="https://mtogo.dk"
          else
            BASE_URL="http://172.16.0.11:7071"
          fi
          echo "BASE_URL=$BASE_URL" >> $GITHUB_ENV
          echo "Testing against: $BASE_URL"

      - name: Wait for Services to be Ready
        run: |
          echo "Waiting for services to be ready..."
          MAX_RETRIES=10
          SLEEP_TIME=5
          
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -sf "${BASE_URL}/api/health" > /dev/null 2>&1; then
              echo "Services are ready!"
              exit 0
            fi
            echo "Attempt $i/$MAX_RETRIES: Services not ready yet, waiting ${SLEEP_TIME}s..."
            sleep $SLEEP_TIME
          done
          
          echo "Services failed to become ready"
          exit 1
        env:
          BASE_URL: ${{ env.BASE_URL }}

      - name: Run UI Acceptance Tests
        id: test-execution
        run: |
          cd ua-tests
          echo "Running UI tests against $BASE_URL"
          mvn clean test -Dtest.environment=${{ inputs.environment }}
        env:
          BASE_URL: ${{ env.BASE_URL }}
          POSTGRES_DB: mtogo
          POSTGRES_USER: mtogo-user
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: Generate Test Report Summary
        if: always()
        run: |
          cd ua-tests
          if [ -d "target/surefire-reports" ]; then
            echo "## UI Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Environment: **${{ inputs.environment }}**" >> $GITHUB_STEP_SUMMARY
            echo "Base URL: \`${{ env.BASE_URL }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # Count test results
            TOTAL=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -h "tests=" {} \; | sed 's/.*tests="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            FAILURES=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -h "failures=" {} \; | sed 's/.*failures="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            ERRORS=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -h "errors=" {} \; | sed 's/.*errors="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
          
            echo "- Total Tests: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- Failures: $FAILURES" >> $GITHUB_STEP_SUMMARY
            echo "- Errors: $ERRORS" >> $GITHUB_STEP_SUMMARY
          
            if [ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**All tests passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tests failed!**" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-reports-${{ inputs.environment }}-${{ github.run_number }}
          path: |
            ua-tests/target/surefire-reports/
            ua-tests/target/screenshots/
          retention-days: 30

      - name: Upload Browser Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: browser-logs-${{ inputs.environment }}-${{ github.run_number }}
          path: ua-tests/target/selenium-logs/
          retention-days: 7