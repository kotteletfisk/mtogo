name: UI Acceptance Tests

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to test against'
        required: true
        type: string
      base_url:
        description: 'Base URL for tests'
        required: true
        type: string
    secrets:
      DB_PASSWORD:
        required: true
    outputs:
      test_result:
        description: 'Test execution result'
        value: ${{ jobs.run-ui-tests.outputs.result }}

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - test
          - prod
        default: test
      base_url:
        description: 'Base URL (optional, uses default for environment)'
        required: false
        type: string

jobs:
  run-ui-tests:
    runs-on:
      - self-hosted
      - ${{ inputs.environment || github.event.inputs.environment }}

    name: Run UI Tests on ${{ inputs.environment || github.event.inputs.environment }}

    env:
      ENVIRONMENT: ${{ inputs.environment || github.event.inputs.environment }}
      BASE_URL_INPUT: ${{ inputs.base_url || github.event.inputs.base_url }}

    outputs:
      result: ${{ steps.test-execution.outcome }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Verify Chrome Installation
        run: google-chrome --version

      - name: Determine Base URL
        id: url
        run: |
          if [ -n "${BASE_URL_INPUT}" ]; then
            BASE_URL="http://localhost:7071"
          elif [ "${ENVIRONMENT}" = "prod" ]; then
            BASE_URL="https://mtogo.dk"
          else
            BASE_URL="http://localhost:7071"
          fi

          echo "BASE_URL=$BASE_URL" >> "$GITHUB_ENV"
          echo "Testing against: $BASE_URL"
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          BASE_URL_INPUT: ${{ env.BASE_URL_INPUT }}

      - name: Load DB settings from server .env
        run: |
          ENV_FILE="/home/${{ secrets.SERVER_NAME }}/mtogo/.env"
          echo "Loading DB settings from $ENV_FILE"

          # Extract the values WITHOUT printing them
          MTOGO_DB=$(grep '^MTOGO_DB=' "$ENV_FILE" | cut -d '=' -f2-)
          MTOGO_USER=$(grep '^MTOGO_USER=' "$ENV_FILE" | cut -d '=' -f2-)
          MTOGO_PASS=$(grep '^MTOGO_PASS=' "$ENV_FILE" | cut -d '=' -f2-)
          
          echo "::add-mask::$MTOGO_USER"
          echo "::add-mask::$MTOGO_DB"
          
          # Export them as POSTGRES_* so CustomerUATests can use them
          echo "POSTGRES_DB=$MTOGO_DB" >> "$GITHUB_ENV"
          echo "POSTGRES_USER=$MTOGO_USER" >> "$GITHUB_ENV"
          echo "POSTGRES_PASSWORD=$MTOGO_PASS" >> "$GITHUB_ENV"

      - name: Wait for Services to be Ready
        run: |
          echo "Waiting for services to be ready..."
          MAX_RETRIES=10
          SLEEP_TIME=5
          
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -sf "${BASE_URL}/api/health" > /dev/null 2>&1; then
              echo "Services are ready!"
              exit 0
            fi
            echo "Attempt $i/$MAX_RETRIES: Services not ready yet, waiting ${SLEEP_TIME}s..."
            sleep $SLEEP_TIME
          done
          
          echo "Services failed to become ready"
          exit 1
        env:
          BASE_URL: ${{ env.BASE_URL }}

      - name: Run UI Acceptance Tests
        id: test-execution
        run: |
          cd ua-tests
          echo "Running UI tests against $BASE_URL (environment=$ENVIRONMENT)"
          mvn clean test -Dtest.environment=${ENVIRONMENT}
        env:
          BASE_URL: ${{ env.BASE_URL }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}

      - name: Generate Test Report Summary
        if: always()
        run: |
          cd ua-tests
          if [ -d "target/surefire-reports" ]; then
            echo "## UI Test Results" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Environment: **${ENVIRONMENT}**" >> "$GITHUB_STEP_SUMMARY"
            echo "Base URL: \`${BASE_URL}\`" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          
            TOTAL=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -h "tests=" {} \; | sed 's/.*tests="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            FAILURES=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -h "failures=" {} \; | sed 's/.*failures="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            ERRORS=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -h "errors=" {} \; | sed 's/.*errors="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
          
            echo "- Total Tests: $TOTAL" >> "$GITHUB_STEP_SUMMARY"
            echo "- Failures: $FAILURES" >> "$GITHUB_STEP_SUMMARY"
            echo "- Errors: $ERRORS" >> "$GITHUB_STEP_SUMMARY"
          
            if [ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "**All tests passed!**" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "**Tests failed!**" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          BASE_URL: ${{ env.BASE_URL }}

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-reports-${{ env.ENVIRONMENT }}-${{ github.run_number }}
          path: |
            ua-tests/target/surefire-reports/
            ua-tests/target/screenshots/
          retention-days: 30

      - name: Upload Browser Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: browser-logs-${{ env.ENVIRONMENT }}-${{ github.run_number }}
          path: ua-tests/target/selenium-logs/
          retention-days: 7
