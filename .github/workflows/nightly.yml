name: Nightly Test, Promote & Deploy

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  STACK_NAME: mtogo-system
  SERVICES: courier-service customer-service management-service supplier-service support-service sql-driver redis-driver mongodb-driver auth-service
  DOCKER_USER: ${{ secrets.DOCKER_USER }}
  DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:
  nightly-test:
    runs-on: [self-hosted, test]
    name: Nightly Test on Test Server
    outputs:
      prod_tag: ${{ steps.promote.outputs.prod_tag }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy Updated Stack File to Test Server
        run: cp docker-stack.yml /home/${{ secrets.SERVER_NAME }}/mtogo/

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Pull Latest Tags & Update .env
        run: |
          echo "" > latest_tags.env
          for svc in $SERVICES; do
            tag=$(curl -s "https://registry.hub.docker.com/v2/repositories/${DOCKER_USER}/$svc/tags?page_size=1" \
                    | jq -r '.results[0].name')
            [ -z "$tag" ] && exit 1
            varname=$(echo $svc | tr 'a-z-' 'A-Z_')_TAG
            echo "$varname=$tag" >> latest_tags.env
            sed -i "s/^${varname}=.*/${varname}=${tag}/" /home/${{ secrets.SERVER_NAME }}/mtogo/.env
          done

      - name: Deploy Test Stack
        run: |
          set -a && . /home/${{ secrets.SERVER_NAME }}/mtogo/.env && docker stack deploy -c /home/${{ secrets.SERVER_NAME }}/mtogo/docker-stack.yml $STACK_NAME

      - name: Wait for Test Services
        run: sleep 60

      - name: Run Heavy Tests
        run: echo "Running very important heavy tests"

      - name: Set up JDK for UI Tests
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Load DB settings from server .env
        run: |
          ENV_FILE="/home/${{ secrets.SERVER_NAME }}/mtogo/.env"
          echo "Loading DB settings from $ENV_FILE"

          # Extract the values WITHOUT printing them
          MTOGO_DB=$(grep '^MTOGO_DB=' "$ENV_FILE" | cut -d '=' -f2-)
          MTOGO_USER=$(grep '^MTOGO_USER=' "$ENV_FILE" | cut -d '=' -f2-)
          MTOGO_PASS=$(grep '^MTOGO_PASS=' "$ENV_FILE" | cut -d '=' -f2-)
          
          echo "::add-mask::$MTOGO_USER"
          echo "::add-mask::$MTOGO_DB"
          echo "::add-mask::$MTOGO_PASS"
          
          echo "POSTGRES_DB=$MTOGO_DB" >> "$GITHUB_ENV"
          echo "POSTGRES_USER=$MTOGO_USER" >> "$GITHUB_ENV"
          echo "POSTGRES_PASSWORD=$MTOGO_PASS" >> "$GITHUB_ENV"

      - name: Run UI Acceptance Tests
        run: |
          cd ua-tests
          mvn clean test
        env:
          BASE_URL: http://172.16.0.11:7071
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          REDIS_HOST: localhost
          REDIS_PORT: 6380

      - name: Upload Test Reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-reports-${{ github.run_number }}
          path: ua-tests/target/surefire-reports/
          retention-days: 7

      - name: Run Performance Tests (Spike Test)
        if: success()
        run: |
          cd ua-tests
          echo "Running 5-minute spike test..."
          mvn test -Dtest=CustomerPerformanceTests#spikeTest_5minutes_customerOrderFlow -Dbase.url=http://172.16.0.11:7071
        env:
          BASE_URL: http://172.16.0.11:7071
        timeout-minutes: 10
        continue-on-error: true  # Don't fail deployment if performance test fails

      - name: Upload Performance Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results-${{ github.run_number }}
          path: ua-tests/target/jmeter-results/
          retention-days: 30

      - name: Check Test Results
        id: testcheck
        run: echo "Checking if test results are fine"

      - name: Promote Images
        id: promote
        if: success()
        run: |
          PROD_TAG="release-$(date +%Y%m%d)-${GITHUB_RUN_NUMBER}"
          echo "PROD_TAG=$PROD_TAG" >> $GITHUB_ENV
          echo "prod_tag=$PROD_TAG" >> $GITHUB_OUTPUT
          
          for svc in $SERVICES; do
            SRC_TAG=$(grep "$(echo $svc | tr 'a-z-' 'A-Z_')_TAG" /home/${{ secrets.SERVER_NAME }}/mtogo/.env | cut -d '=' -f2)
            docker pull "$DOCKER_USER/$svc:$SRC_TAG"
            docker tag "$DOCKER_USER/$svc:$SRC_TAG" "$DOCKER_USER/$svc:$PROD_TAG"
            docker push "$DOCKER_USER/$svc:$PROD_TAG"
          done


  deploy-prod:
    needs: nightly-test
    runs-on: [self-hosted, prod]
    if: ${{ needs.nightly-test.result == 'success' }}
    name: Deploy to Production
    env:
      PROD_TAG: ${{ needs.nightly-test.outputs.prod_tag }}

    steps:

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Copy Stack File to Prod
        run: cp docker-stack.yml /home/${{ secrets.SERVER_NAME }}/mtogo/

      - name: Update Prod .env With Promoted Tag
        run: |
          for svc in $SERVICES; do
            sed -i "s/^$(echo $svc | tr 'a-z-' 'A-Z_')_TAG=.*/$(echo $svc | tr 'a-z-' 'A-Z_')_TAG=$PROD_TAG/" /home/${{ secrets.SERVER_NAME }}/mtogo/.env
          done

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Deploy Prod Stack
        run: |
          set -a && . /home/${{ secrets.SERVER_NAME }}/mtogo/.env && docker stack deploy -c /home/${{ secrets.SERVER_NAME }}/mtogo/docker-stack.yml $STACK_NAME

      - name: Wait for Services to Start
        run: sleep 45

      - name: Health Check
        id: healthcheck
        run: |
          MAX_RETRIES=10
          SLEEP_INTERVAL=30

          function check_health {
            local URL=$1
            for i in $(seq 1 $MAX_RETRIES); do
              HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "$URL" || echo "000")
              if [ "$HTTP_CODE" -eq 200 ]; then
                echo "$URL healthy."
                return 0
              else
                echo "Attempt $i/$MAX_RETRIES for $URL failed (HTTP $HTTP_CODE). Retrying in $SLEEP_INTERVAL s..."
                sleep $SLEEP_INTERVAL
              fi
            done
            echo "$URL failed healthcheck."
            return 1
          }

          
          check_health "http://localhost:7071/api/health"
          check_health "http://localhost:7070/api/health"
          check_health "http://localhost:7075/api/health"

      - name: On Fail → Rollback & Notify Discord
        if: failure()
        run: |
          source /home/${{ secrets.SERVER_NAME }}/mtogo/last-stable.env
          echo "ROLLBACK to $LAST_STABLE"
          for svc in $SERVICES; do
            sed -i "s/^$(echo $svc | tr 'a-z-' 'A-Z_')_TAG=.*/$(echo $svc | tr 'a-z-' 'A-Z_')_TAG=$LAST_STABLE/" /home/${{ secrets.SERVER_NAME }}/mtogo/.env
          done
          set -a && . /home/${{ secrets.SERVER_NAME }}/mtogo/.env && docker stack deploy -c /home/${{ secrets.SERVER_NAME }}/mtogo/docker-stack.yml $STACK_NAME
          curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"❌ Deployment FAILED on production. Rolled back to $LAST_STABLE\"}" $DISCORD_WEBHOOK

      - name: On Success update last stable and Notify Discord
        if: success()
        run: |
          echo "LAST_STABLE=$PROD_TAG" | tee /home/${{ secrets.SERVER_NAME }}/mtogo/last-stable.env > /dev/null
          curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"✅ Deployment SUCCESS on production! All systems healthy.\"}" $DISCORD_WEBHOOK
