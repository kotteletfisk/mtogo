name: Build & Push Changed Services

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - '.github/workflows/ci-on-push.yml'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.format-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      # Detect changed services using paths-filter
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            example-service:
              - 'services/example-service/**'

      # Format the matrix for GitHub Actions
      - id: format-matrix
        run: |
          echo "[]" > matrix.json
          for SERVICE in $(jq -r 'keys[]' <<< '${{ steps.filter.outputs.changes }}'); do
            CHANGED=$(jq -r --arg s "$SERVICE" '.[$s].changes' <<< '${{ steps.filter.outputs.changes }}')
            if [ "$CHANGED" == "true" ]; then
              jq --arg s "$SERVICE" '. += [{"service": $s}]' matrix.json > tmp.json
              mv tmp.json matrix.json
            fi
          done
          echo "matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT

  build:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ needs.detect-changes.outputs.matrix }}

    steps:
      - uses: actions/checkout@v4

      # Detect language environment and install runtime
      - name: Set up language runtime
        run: |
          LANG_FILE="services/${{ matrix.service }}/lang-env.txt"
          if [ -f "$LANG_FILE" ]; then
            LANG=$(cat "$LANG_FILE")
            echo "Detected language/runtime: $LANG"
            if [[ "$LANG" == java-* ]]; then
              JAVA_VERSION=${LANG#java-}
              echo "Installing Java $JAVA_VERSION"
              echo "JAVA_HOME=$(java -version || true)"
              # Setup Java via setup-java action
              echo "Setting up Java $JAVA_VERSION"
              echo "JAVA_VERSION=$JAVA_VERSION" >> $GITHUB_ENV
              # Actually install Java
              echo "Installing via setup-java..."
              uses: actions/setup-java@v4
              with:
                distribution: temurin
                java-version: $JAVA_VERSION
          else
            echo "No lang-env.txt found, skipping runtime setup"
          fi

      # Run service-specific tests
      - name: Run tests
        working-directory: services/${{ matrix.service }}
        run: |
          chmod +x run_tests.sh
          ./run_tests.sh

      # Log in to GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build image
      - name: Build Docker image
        run: |
          IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:sha-${{ github.sha }}
          docker build -t $IMAGE_TAG services/${{ matrix.service }}

      # Push image
      - name: Push Docker image
        run: |
          IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:sha-${{ github.sha }}
          docker push $IMAGE_TAG