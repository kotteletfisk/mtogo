name: Build & Push Changed Services

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - '.github/workflows/ci-on-push.yml'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: actions/checkout@v4

      - id: filter
        uses: dorny/paths-filter@v3
        with:
          list-files: 'json'
          filters: |
            example-service:
              - 'services/example-service/**'

  build:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      # Detect language and install runtime
      - name: Set up language runtime
        run: |
          LANG_FILE="services/${{ matrix.service }}/lang-env.txt"
          if [ -f "$LANG_FILE" ]; then
            LANG=$(cat "$LANG_FILE")
            echo "Detected language/runtime: $LANG"
            if [[ "$LANG" == java-* ]]; then
              JAVA_VERSION=${LANG#java-}
              echo "Setting up Java $JAVA_VERSION"
              echo "JAVA_HOME=$(java -version || true)"
              # Use setup-java action
              echo "Installing Java $JAVA_VERSION"
              echo "Installing Java via setup-java action"

            else
              echo "Unknown language $LANG, skipping runtime setup"
            fi
          else
            echo "No language.txt found, skipping runtime setup"
          fi

      # Run service-specific tests
      - name: Run tests
        working-directory: services/${{ matrix.service }}
        run: |
          chmod +x run_tests.sh
          ./run_tests.sh

      # Log in to Docker registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build Docker image
      - name: Build Docker image
        run: |
          IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:sha-${{ github.sha }}
          docker build -t $IMAGE_TAG services/${{ matrix.service }}

      # Push Docker image
      - name: Push Docker image
        run: |
          IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:sha-${{ github.sha }}
          docker push $IMAGE_TAG