name: Test & Build Changed Services

on:
  push:
    branches: [main]
    paths:
      - 'services/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
    paths:
      - 'services/**'
      - '.github/workflows/**'

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: mtogo-test
    outputs:
      changed-services: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          list-files: 'json'
          filters: |
            courier-service:
              - 'services/courier-service/**'
            customer-service:
              - 'services/customer-service/**'
            management-service:
              - 'services/management-service/**'
            mongodb-driver:
              - 'services/mongodb-driver/**'
            redis-driver:
              - 'services/redis-driver/**'
            sql-driver:
              - 'services/sql-driver/**'
            supplier-service:
              - 'services/supplier-service/**'
            support-service:
              - 'services/support-service/**'
            


  test-and-build:
    name: Test & Build per Service
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.changed-services != '[]' }}
    runs-on: mtogo-test
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed-services) }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect Service Language
        id: detect
        run: |
          svc_dir="services/${{ matrix.service }}"
          if [ -f "$svc_dir/pom.xml" ]; then
            lang="java"
          else
            echo "No supported language detected in $svc_dir"
            exit 1
          fi
          echo "language=$lang" >> $GITHUB_OUTPUT

      # Java / Maven
      - name: Set up JDK
        if: ${{ steps.detect.outputs.language == 'java' }}
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
        
      - name: Test with Maven
        if: ${{ steps.detect.outputs.language == 'java' }}
        run: mvn --batch-mode --update-snapshots verify
        working-directory: services/${{ matrix.service }}

      # Build & Push Docker image (only on push to main)
      - name: Log in to DockerHub
        if: ${{ github.event_name == 'push' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build & Push Docker image
        if: ${{ github.event_name == 'push' }}
        run: |
          IMAGE="${{ secrets.DOCKER_USER }}/${{ matrix.service }}"
          TAG="sha-${{ github.sha }}"

          echo "Building $IMAGE:$TAG"

          docker build -t "$IMAGE:$TAG" "services/${{ matrix.service }}"
          docker push "$IMAGE:$TAG"

          echo "Image pushed: $IMAGE:$TAG"


 