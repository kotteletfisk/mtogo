<script type="text/babel">
    const { useState, useMemo } = React;

    function OrderForm() {
        const [customerId, setCustomerId] = useState("");
        const [status, setStatus] = useState("created");
        const [orderLines, setOrderLines] = useState([
            { item_id: "", price_snapshot: "", amount: "" },
        ]);
        const [paymentMethod, setPaymentMethod] = useState("PAYPAL");
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [message, setMessage] = useState(null);

        // NEW: supplier / menu state
        const [zipcode, setZipcode] = useState("");
        const [suppliers, setSuppliers] = useState([]);
        const [selectedSupplierId, setSelectedSupplierId] = useState("");
        const [menuItems, setMenuItems] = useState([]);
        const [isLoadingSuppliers, setIsLoadingSuppliers] = useState(false);
        const [isLoadingItems, setIsLoadingItems] = useState(false);

        // Helpers to be robust against DTO property names
        const getItemId = (item) => item.itemId ?? item.id ?? item.item_id;
        const getItemName = (item) => item.name ?? item.itemName ?? item.title ?? `Item ${getItemId(item)}`;
        const getItemPrice = (item) =>
            item.price ??
            item.priceSnapshot ??
            item.price_snapshot ??
            0;

        const total = useMemo(() => {
            return orderLines.reduce((sum, line) => {
                const price = parseFloat(line.price_snapshot || "0");
                const amount = parseInt(line.amount || "0", 10);
                return sum + (isNaN(price) || isNaN(amount) ? 0 : price * amount);
            }, 0);
        }, [orderLines]);

        const updateLine = (index, field, value) => {
            setOrderLines((prev) => {
                const copy = [...prev];
                copy[index] = { ...copy[index], [field]: value };
                return copy;
            });
        };

        const addLine = () => {
            setOrderLines((prev) => [
                ...prev,
                { item_id: "", price_snapshot: "", amount: "" },
            ]);
        };

        const removeLine = (index) => {
            setOrderLines((prev) => prev.filter((_, i) => i !== index));
        };

        const resetForm = () => {
            setCustomerId("");
            setStatus("created");
            setOrderLines([{ item_id: "", price_snapshot: "", amount: "" }]);
            setPaymentMethod("PAYPAL");
            // Keep supplier selection, it's a separate concern
        };

        // NEW: fetch active suppliers by zipcode
        const fetchSuppliers = async () => {
            setMessage(null);
            setSuppliers([]);
            setMenuItems([]);
            setSelectedSupplierId("");

            const trimmedZip = zipcode.trim();
            if (!trimmedZip) {
                setMessage({
                    type: "error",
                    text: "Please enter a zipcode before searching for suppliers.",
                });
                return;
            }

            setIsLoadingSuppliers(true);
            try {
                const res = await fetch(`/api/suppliers/${encodeURIComponent(trimmedZip)}`);
                const text = await res.text();

                if (!res.ok) {
                    setMessage({
                        type: "error",
                        text:
                            text && text.trim().length > 0
                                ? `Error ${res.status} while fetching suppliers: ${text}`
                                : `Error ${res.status} while fetching suppliers.`,
                    });
                    return;
                }

                const data = text ? JSON.parse(text) : [];
                setSuppliers(Array.isArray(data) ? data : []);
                if (Array.isArray(data) && data.length === 0) {
                    setMessage({
                        type: "error",
                        text: "No active suppliers found for that zipcode.",
                    });
                }
            } catch (err) {
                setMessage({
                    type: "error",
                    text: "Network or server error while fetching suppliers: " + err.message,
                });
            } finally {
                setIsLoadingSuppliers(false);
            }
        };

        // NEW: fetch menu items for selected supplier
        const fetchMenuItems = async () => {
            setMessage(null);
            setMenuItems([]);

            if (!selectedSupplierId) {
                setMessage({
                    type: "error",
                    text: "Please select a supplier before loading menu items.",
                });
                return;
            }

            setIsLoadingItems(true);
            try {
                const res = await fetch(`/api/${encodeURIComponent(selectedSupplierId)}/items`);
                const text = await res.text();

                if (!res.ok) {
                    setMessage({
                        type: "error",
                        text:
                            text && text.trim().length > 0
                                ? `Error ${res.status} while fetching menu items: ${text}`
                                : `Error ${res.status} while fetching menu items.`,
                    });
                    return;
                }

                const data = text ? JSON.parse(text) : [];
                setMenuItems(Array.isArray(data) ? data : []);
                if (Array.isArray(data) && data.length === 0) {
                    setMessage({
                        type: "error",
                        text: "No menu items returned for this supplier.",
                    });
                }
            } catch (err) {
                setMessage({
                    type: "error",
                    text: "Network or server error while fetching menu items: " + err.message,
                });
            } finally {
                setIsLoadingItems(false);
            }
        };

        // NEW: add item from menu into order lines
        const addOrderLineFromMenuItem = (item) => {
            const itemId = getItemId(item);
            const price = getItemPrice(item);

            if (!itemId) {
                setMessage({
                    type: "error",
                    text: "Selected menu item is missing an ID.",
                });
                return;
            }

            setOrderLines((prev) => [
                ...prev,
                {
                    item_id: String(itemId),
                    price_snapshot: String(price),
                    amount: "1",
                },
            ]);
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            setMessage(null);

            if (!customerId) {
                setMessage({ type: "error", text: "Customer ID is required." });
                return;
            }

            const cleanedLines = orderLines
                .filter((l) => l.item_id && l.amount && l.price_snapshot)
                .map((l) => ({
                    itemId: Number(l.item_id),
                    priceSnapshot: Number(l.price_snapshot),
                    amount: Number(l.amount),
                }));

            if (cleanedLines.length === 0) {
                setMessage({
                    type: "error",
                    text: "You must add at least one valid order line.",
                });
                return;
            }

            const payload = {
                customerId: Number(customerId),
                status,
                orderLines: cleanedLines,
                paymentMethod,
            };

            setIsSubmitting(true);
            try {
                const res = await fetch("/api/createorder", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                let text = "";
                try {
                    text = await res.text();
                } catch (_) {}

                if (res.ok) {
                    setMessage({
                        type: "success",
                        text:
                            text && text.trim().length > 0
                                ? `Order created and payment processed. Server said: ${text}`
                                : "Order created and payment processed (empty response body).",
                    });
                    resetForm();
                } else {
                    setMessage({
                        type: "error",
                        text:
                            text && text.trim().length > 0
                                ? `Error ${res.status}: ${text}`
                                : `Error ${res.status} while creating order or processing payment.`,
                    });
                }
            } catch (err) {
                setMessage({
                    type: "error",
                    text:
                        "Network or server error while creating order: " + err.message,
                });
            } finally {
                setIsSubmitting(false);
            }
        };

        return (
            <div className="page">
                <h1>Customer Service – Create Order</h1>
                <p className="subtitle">
                    Internal tool for placing orders directly into the system.
                    <span className="badge">CS only</span>
                </p>

                {/* NEW: Supplier & menu section */}
                <div className="section">
                    <h3>Suppliers & Menu</h3>

                    {/* Zipcode + fetch suppliers */}
                    <div className="grid" style={{ marginBottom: "0.75rem" }}>
                        <div>
                            <label htmlFor="zipcode">Zipcode</label>
                            <input
                                id="zipcode"
                                type="text"
                                value={zipcode}
                                onChange={(e) => setZipcode(e.target.value)}
                                placeholder="e.g. 2100"
                            />
                        </div>
                        <div style={{ display: "flex", alignItems: "flex-end" }}>
                            <button
                                type="button"
                                className="btn btn-secondary"
                                onClick={fetchSuppliers}
                                disabled={isLoadingSuppliers}
                            >
                                {isLoadingSuppliers ? "Loading suppliers…" : "Find active suppliers"}
                            </button>
                        </div>
                    </div>

                    {/* Supplier dropdown */}
                    {suppliers.length > 0 && (
                        <div className="grid" style={{ marginBottom: "0.75rem" }}>
                            <div>
                                <label htmlFor="supplierSelect">Select supplier</label>
                                <select
                                    id="supplierSelect"
                                    value={selectedSupplierId}
                                    onChange={(e) => setSelectedSupplierId(e.target.value)}
                                >
                                    <option value="">-- choose --</option>
                                    {suppliers.map((s) => (
                                        <option key={s.supplierId} value={s.supplierId}>
                                            {s.name} (#{s.supplierId})
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div style={{ display: "flex", alignItems: "flex-end" }}>
                                <button
                                    type="button"
                                    className="btn btn-secondary"
                                    onClick={fetchMenuItems}
                                    disabled={isLoadingItems || !selectedSupplierId}
                                >
                                    {isLoadingItems ? "Loading menu…" : "Load menu items"}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Menu items list */}
                    {menuItems.length > 0 && (
                        <div style={{ marginTop: "0.5rem" }}>
                            <label>Menu items for selected supplier</label>
                            <div
                                style={{
                                    border: "1px solid #e5e7eb",
                                    borderRadius: "8px",
                                    padding: "0.5rem",
                                    maxHeight: "200px",
                                    overflowY: "auto",
                                    fontSize: "0.9rem",
                                }}
                            >
                                {menuItems.map((item) => {
                                    const itemId = getItemId(item);
                                    const name = getItemName(item);
                                    const price = getItemPrice(item);

                                    return (
                                        <div
                                            key={itemId}
                                            style={{
                                                display: "flex",
                                                justifyContent: "space-between",
                                                alignItems: "center",
                                                padding: "0.25rem 0",
                                                borderBottom: "1px solid #f3f4f6",
                                            }}
                                        >
                                            <div>
                                                <strong>{name}</strong>{" "}
                                                <span style={{ color: "#6b7280" }}>
                                                    (ID: {itemId})
                                                </span>
                                            </div>
                                            <div style={{ display: "flex", alignItems: "center", gap: "0.75rem" }}>
                                                <span>{price} kr</span>
                                                <button
                                                    type="button"
                                                    className="btn btn-primary"
                                                    onClick={() => addOrderLineFromMenuItem(item)}
                                                >
                                                    Add to order
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>

                <form onSubmit={handleSubmit}>
                    {/* Order info */}
                    <div className="section">
                        <h3>Order Info</h3>
                        <div className="grid">
                            <div>
                                <label htmlFor="customerId">Customer ID</label>
                                <input
                                    id="customerId"
                                    type="number"
                                    min="1"
                                    value={customerId}
                                    onChange={(e) => setCustomerId(e.target.value)}
                                    placeholder="e.g. 1"
                                    required
                                />
                            </div>

                            <div>
                                <label htmlFor="status">Status</label>
                                <select
                                    id="status"
                                    value={status}
                                    onChange={(e) => setStatus(e.target.value)}
                                >
                                    <option value="created">created</option>
                                    <option value="confirmed">confirmed</option>
                                    <option value="preparing">preparing</option>
                                    <option value="sent">sent</option>
                                    <option value="delivered">delivered</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Payment */}
                    <div className="section">
                        <h3>Payment</h3>
                        <div className="grid">
                            <div>
                                <label htmlFor="paymentMethod">Payment method</label>
                                <select
                                    id="paymentMethod"
                                    value={paymentMethod}
                                    onChange={(e) => setPaymentMethod(e.target.value)}
                                >
                                    <option value="PAYPAL">PayPal</option>
                                    <option value="MOBILEPAY">MobilePay</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Order lines */}
                    <div className="section">
                        <h3>Order Lines</h3>
                        {orderLines.map((line, index) => (
                            <div className="orderline-row" key={index}>
                                <div>
                                    <label>Item ID</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={line.item_id}
                                        onChange={(e) =>
                                            updateLine(index, "item_id", e.target.value)
                                        }
                                        placeholder="item_id"
                                    />
                                </div>
                                <div>
                                    <label>Price snapshot</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        value={line.price_snapshot}
                                        onChange={(e) =>
                                            updateLine(
                                                index,
                                                "price_snapshot",
                                                e.target.value
                                            )
                                        }
                                        placeholder="e.g. 49.95"
                                    />
                                </div>
                                <div>
                                    <label>Amount</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={line.amount}
                                        onChange={(e) =>
                                            updateLine(index, "amount", e.target.value)
                                        }
                                        placeholder="e.g. 2"
                                    />
                                </div>
                                <div>
                                    <button
                                        type="button"
                                        className="btn btn-danger"
                                        onClick={() => removeLine(index)}
                                        disabled={orderLines.length === 1}
                                    >
                                        ✕
                                    </button>
                                </div>
                            </div>
                        ))}

                        <button
                            type="button"
                            className="btn btn-secondary"
                            onClick={addLine}
                        >
                            + Add order line
                        </button>

                        <div className="order-total">
                            <strong>Total:</strong> {total.toFixed(2)}
                        </div>
                    </div>

                    {/* Actions */}
                    <div className="actions">
                        <button
                            type="submit"
                            className="btn btn-primary"
                            disabled={isSubmitting}
                        >
                            {isSubmitting ? "Creating…" : "Create order"}
                        </button>
                        <button
                            type="button"
                            className="btn btn-secondary"
                            onClick={resetForm}
                            disabled={isSubmitting}
                        >
                            Clear
                        </button>
                    </div>

                    {/* Status message */}
                    {message && (
                        <div
                            className={
                                "status-message " +
                                (message.type === "success"
                                    ? "status-success"
                                    : "status-error")
                            }
                        >
                            {message.text}
                        </div>
                    )}
                </form>
            </div>
        );
    }

    const rootEl = document.getElementById("root");
    const root = ReactDOM.createRoot(rootEl);
    root.render(<OrderForm />);
</script>
