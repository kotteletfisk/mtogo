<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>MTOGO – Customer Service Order Tool</title>

    <!-- React & ReactDOM (UMD builds) -->
    <script
            src="https://unpkg.com/react@18/umd/react.development.js"
            crossorigin
    ></script>
    <script
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
            crossorigin
    ></script>

    <!-- Babel standalone, needed for type="text/babel" + JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
            sans-serif;
            margin: 0;
            padding: 2rem;
            background: #f7f7f8;
        }
        .page {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }
        h1 {
            margin-top: 0;
        }
        .subtitle {
            color: #555;
            margin-bottom: 1.5rem;
        }
        .badge {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.15rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 999px;
            background: #eee;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .section {
            margin-bottom: 1.5rem;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            color: #333;
        }
        input,
        select {
            width: 100%;
            box-sizing: border-box;
            padding: 0.5rem 0.6rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 0.95rem;
        }
        .orderline-row {
            display: grid;
            grid-template-columns: 1.5fr 1.5fr 1fr auto;
            gap: 0.75rem;
            align-items: end;
            margin-bottom: 0.75rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.45rem 0.9rem;
            border-radius: 6px;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: default;
        }
        .order-total {
            margin-top: 0.75rem;
            font-size: 1rem;
        }
        .actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .status-message {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .status-success {
            background: #ecfdf3;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status-error {
            background: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }
    </style>
</head>

<body>
<!-- IMPORTANT: this must exist before the React code runs -->
<div id="root"></div>

<!-- Your React/Babel app -->
<script type="text/babel">
    const { useState, useMemo } = React;

    function OrderForm() {
        const [customerId, setCustomerId] = useState("");
        const [status, setStatus] = useState("created");
        const [orderLines, setOrderLines] = useState([
            { item_id: "", price_snapshot: "", amount: "" },
        ]);
        const [paymentMethod, setPaymentMethod] = useState("PAYPAL");
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [message, setMessage] = useState(null);

        const total = useMemo(() => {
            return orderLines.reduce((sum, line) => {
                const price = parseFloat(line.price_snapshot || "0");
                const amount = parseInt(line.amount || "0", 10);
                return sum + (isNaN(price) || isNaN(amount) ? 0 : price * amount);
            }, 0);
        }, [orderLines]);

        const updateLine = (index, field, value) => {
            setOrderLines((prev) => {
                const copy = [...prev];
                copy[index] = { ...copy[index], [field]: value };
                return copy;
            });
        };

        const addLine = () => {
            setOrderLines((prev) => [
                ...prev,
                { item_id: "", price_snapshot: "", amount: "" },
            ]);
        };

        const removeLine = (index) => {
            setOrderLines((prev) => prev.filter((_, i) => i !== index));
        };

        const resetForm = () => {
            setCustomerId("");
            setStatus("created");
            setOrderLines([{ item_id: "", price_snapshot: "", amount: "" }]);
            setPaymentMethod("PAYPAL");
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            setMessage(null);

            if (!customerId) {
                setMessage({ type: "error", text: "Customer ID is required." });
                return;
            }

            const cleanedLines = orderLines
                .filter((l) => l.item_id && l.amount && l.price_snapshot)
                .map((l) => ({
                    item_id: Number(l.item_id),
                    price_snapshot: Number(l.price_snapshot),
                    amount: Number(l.amount),
                }));

            if (cleanedLines.length === 0) {
                setMessage({
                    type: "error",
                    text: "You must add at least one valid order line.",
                });
                return;
            }

            const payload = {
                customerId: Number(customerId),
                status,
                orderLines: cleanedLines,
                paymentMethod,
            };

            setIsSubmitting(true);
            try {
                const res = await fetch("/api/createorder", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                let text = "";
                try {
                    text = await res.text();
                } catch (_) {}

                if (res.ok) {
                    setMessage({
                        type: "success",
                        text:
                            text && text.trim().length > 0
                                ? `Order created and payment processed. Server said: ${text}`
                                : "Order created and payment processed (empty response body).",
                    });
                    resetForm();
                } else {
                    setMessage({
                        type: "error",
                        text:
                            text && text.trim().length > 0
                                ? `Error ${res.status}: ${text}`
                                : `Error ${res.status} while creating order or processing payment.`,
                    });
                }
            } catch (err) {
                setMessage({
                    type: "error",
                    text:
                        "Network or server error while creating order: " + err.message,
                });
            } finally {
                setIsSubmitting(false);
            }
        };

        return (
            <div className="page">
                <h1>Customer Service – Create Order</h1>
                <p className="subtitle">
                    Internal tool for placing orders directly into the system.
                    <span className="badge">CS only</span>
                </p>

                <form onSubmit={handleSubmit}>
                    {/* Order info */}
                    <div className="section">
                        <h3>Order Info</h3>
                        <div className="grid">
                            <div>
                                <label htmlFor="customerId">Customer ID</label>
                                <input
                                    id="customerId"
                                    type="number"
                                    min="1"
                                    value={customerId}
                                    onChange={(e) => setCustomerId(e.target.value)}
                                    placeholder="e.g. 1"
                                    required
                                />
                            </div>

                            <div>
                                <label htmlFor="status">Status</label>
                                <select
                                    id="status"
                                    value={status}
                                    onChange={(e) => setStatus(e.target.value)}
                                >
                                    <option value="created">created</option>
                                    <option value="confirmed">confirmed</option>
                                    <option value="preparing">preparing</option>
                                    <option value="sent">sent</option>
                                    <option value="delivered">delivered</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Payment */}
                    <div className="section">
                        <h3>Payment</h3>
                        <div className="grid">
                            <div>
                                <label htmlFor="paymentMethod">Payment method</label>
                                <select
                                    id="paymentMethod"
                                    value={paymentMethod}
                                    onChange={(e) => setPaymentMethod(e.target.value)}
                                >
                                    <option value="PAYPAL">PayPal</option>
                                    <option value="MOBILEPAY">MobilePay</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Order lines */}
                    <div className="section">
                        <h3>Order Lines</h3>
                        {orderLines.map((line, index) => (
                            <div className="orderline-row" key={index}>
                                <div>
                                    <label>Item ID</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={line.item_id}
                                        onChange={(e) =>
                                            updateLine(index, "item_id", e.target.value)
                                        }
                                        placeholder="item_id"
                                    />
                                </div>
                                <div>
                                    <label>Price snapshot</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        value={line.price_snapshot}
                                        onChange={(e) =>
                                            updateLine(
                                                index,
                                                "price_snapshot",
                                                e.target.value
                                            )
                                        }
                                        placeholder="e.g. 49.95"
                                    />
                                </div>
                                <div>
                                    <label>Amount</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={line.amount}
                                        onChange={(e) =>
                                            updateLine(index, "amount", e.target.value)
                                        }
                                        placeholder="e.g. 2"
                                    />
                                </div>
                                <div>
                                    <button
                                        type="button"
                                        className="btn btn-danger"
                                        onClick={() => removeLine(index)}
                                        disabled={orderLines.length === 1}
                                    >
                                        ✕
                                    </button>
                                </div>
                            </div>
                        ))}

                        <button
                            type="button"
                            className="btn btn-secondary"
                            onClick={addLine}
                        >
                            + Add order line
                        </button>

                        <div className="order-total">
                            <strong>Total:</strong> {total.toFixed(2)}
                        </div>
                    </div>

                    {/* Actions */}
                    <div className="actions">
                        <button
                            type="submit"
                            className="btn btn-primary"
                            disabled={isSubmitting}
                        >
                            {isSubmitting ? "Creating…" : "Create order"}
                        </button>
                        <button
                            type="button"
                            className="btn btn-secondary"
                            onClick={resetForm}
                            disabled={isSubmitting}
                        >
                            Clear
                        </button>
                    </div>

                    {/* Status message */}
                    {message && (
                        <div
                            className={
                                "status-message " +
                                (message.type === "success"
                                    ? "status-success"
                                    : "status-error")
                            }
                        >
                            {message.text}
                        </div>
                    )}
                </form>
            </div>
        );
    }

    const rootEl = document.getElementById("root");
    const root = ReactDOM.createRoot(rootEl);
    root.render(<OrderForm />);
</script>
</body>
</html>
