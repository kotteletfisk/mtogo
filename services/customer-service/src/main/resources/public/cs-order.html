<script type="text/babel">
    const { useState, useMemo } = React;

    function OrderForm() {
        const [customerId, setCustomerId] = useState("");
        const [status, setStatus] = useState("created");
        const [orderLines, setOrderLines] = useState([
            { item_id: "", price_snapshot: "", amount: "" },
        ]);
        const [paymentMethod, setPaymentMethod] = useState("PAYPAL"); // NEW
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [message, setMessage] = useState(null); // { type: "success" | "error", text: string }

        const total = useMemo(() => {
            return orderLines.reduce((sum, line) => {
                const price = parseFloat(line.price_snapshot || "0");
                const amount = parseInt(line.amount || "0", 10);
                return sum + (isNaN(price) || isNaN(amount) ? 0 : price * amount);
            }, 0);
        }, [orderLines]);

        const updateLine = (index, field, value) => {
            setOrderLines((prev) => {
                const copy = [...prev];
                copy[index] = { ...copy[index], [field]: value };
                return copy;
            });
        };

        const addLine = () => {
            setOrderLines((prev) => [...prev, { item_id: "", price_snapshot: "", amount: "" }]);
        };

        const removeLine = (index) => {
            setOrderLines((prev) => prev.filter((_, i) => i !== index));
        };

        const resetForm = () => {
            setCustomerId("");
            setStatus("created");
            setOrderLines([{ item_id: "", price_snapshot: "", amount: "" }]);
            setPaymentMethod("PAYPAL"); // reset too
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            setMessage(null);

            if (!customerId) {
                setMessage({ type: "error", text: "Customer ID is required." });
                return;
            }

            const cleanedLines = orderLines
                .filter((l) => l.item_id && l.amount && l.price_snapshot)
                .map((l) => ({
                    item_id: Number(l.item_id),
                    price_snapshot: Number(l.price_snapshot),
                    amount: Number(l.amount),
                }));

            if (cleanedLines.length === 0) {
                setMessage({ type: "error", text: "You must add at least one valid order line." });
                return;
            }

            const payload = {
                customerId: Number(customerId),
                status,
                orderLines: cleanedLines,
                paymentMethod, // NEW: "PAYPAL" or "MOBILEPAY"
            };

            setIsSubmitting(true);
            try {
                const res = await fetch("/api/createorder", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                let text = "";
                try {
                    text = await res.text();
                } catch (_) {}

                if (res.ok) {
                    setMessage({
                        type: "success",
                        text:
                            text && text.trim().length > 0
                                ? `Order created and payment processed. Server said: ${text}`
                                : "Order created and payment processed (empty response body).",
                    });
                    resetForm();
                } else {
                    setMessage({
                        type: "error",
                        text:
                            text && text.trim().length > 0
                                ? `Error ${res.status}: ${text}`
                                : `Error ${res.status} while creating order or processing payment.`,
                    });
                }
            } catch (err) {
                setMessage({
                    type: "error",
                    text: "Network or server error while creating order: " + err.message,
                });
            } finally {
                setIsSubmitting(false);
            }
        };

        return (
            <div className="page">
                <h1>Customer Service – Create Order</h1>
                <p className="subtitle">
                    Internal tool for placing orders directly into the system.
                    <span className="badge">CS only</span>
                </p>

                <form onSubmit={handleSubmit}>
                    {/* Customer + status */}
                    <div className="section">
                        <h3>Order Info</h3>
                        <div className="grid">
                            <div>
                                <label htmlFor="customerId">Customer ID</label>
                                <input
                                    id="customerId"
                                    type="number"
                                    min="1"
                                    value={customerId}
                                    onChange={(e) => setCustomerId(e.target.value)}
                                    placeholder="e.g. 1"
                                    required
                                />
                            </div>

                            <div>
                                <label htmlFor="status">Status</label>
                                <select
                                    id="status"
                                    value={status}
                                    onChange={(e) => setStatus(e.target.value)}
                                >
                                    <option value="created">created</option>
                                    <option value="confirmed">confirmed</option>
                                    <option value="preparing">preparing</option>
                                    <option value="sent">sent</option>
                                    <option value="delivered">delivered</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Payment method - NEW */}
                    <div className="section">
                        <h3>Payment</h3>
                        <div className="grid">
                            <div>
                                <label htmlFor="paymentMethod">Payment method</label>
                                <select
                                    id="paymentMethod"
                                    value={paymentMethod}
                                    onChange={(e) => setPaymentMethod(e.target.value)}
                                >
                                    <option value="PAYPAL">PayPal</option>
                                    <option value="MOBILEPAY">MobilePay</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Order lines */}
                    <div className="section">
                        <h3>Order Lines</h3>
                        {orderLines.map((line, index) => (
                            <div className="orderline-row" key={index}>
                                <div>
                                    <label>Item ID</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={line.item_id}
                                        onChange={(e) => updateLine(index, "item_id", e.target.value)}
                                        placeholder="item_id"
                                    />
                                </div>
                                <div>
                                    <label>Price snapshot</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        value={line.price_snapshot}
                                        onChange={(e) => updateLine(index, "price_snapshot", e.target.value)}
                                        placeholder="e.g. 49.95"
                                    />
                                </div>
                                <div>
                                    <label>Amount</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={line.amount}
                                        onChange={(e) => updateLine(index, "amount", e.target.value)}
                                        placeholder="e.g. 2"
                                    />
                                </div>
                                <div>
                                    <button
                                        type="button"
                                        className="btn btn-danger"
                                        onClick={() => removeLine(index)}
                                        disabled={orderLines.length === 1}
                                    >
                                        ✕
                                    </button>
                                </div>
                            </div>
                        ))}

                        <button type="button" className="btn btn-secondary" onClick={addLine}>
                            + Add order line
                        </button>

                        <div className="order-total">
                            <strong>Total:</strong> {total.toFixed(2)}
                        </div>
                    </div>

                    {/* Actions */}
                    <div className="actions">
                        <button type="submit" className="btn btn-primary" disabled={isSubmitting}>
                            {isSubmitting ? "Creating…" : "Create order"}
                        </button>
                        <button
                            type="button"
                            className="btn btn-secondary"
                            onClick={resetForm}
                            disabled={isSubmitting}
                        >
                            Clear
                        </button>
                    </div>

                    {/* Status message */}
                    {message && (
                        <div
                            className={
                                "status-message " +
                                (message.type === "success" ? "status-success" : "status-error")
                            }
                        >
                            {message.text}
                        </div>
                    )}
                </form>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<OrderForm />);
</script>
